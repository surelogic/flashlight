<project name="flashlight-instrumentation-5.0" default="build-asm-jars">

	<property environment="env" />

	<property name="lib" value="${basedir}/lib" />
	<property name="classes" value="${basedir}/bin" />
	
	<property name="src" value="${basedir}/src" />
	<property name="src-asm" value="${basedir}/src-asm" />
	<property name="test" value="${basedir}/test" />

	<property name="asm.jar" value="${lib}/asm-3.1.jar" />
	<property name="servlet.jar" value="${lib}/servlet-2_5-api.jar" />

	<property name="junit.jar" value="${lib}/junit-4.3.1.jar" />

	<property name="flashlight-asm-all.jar" value="${basedir}/flashlight-asm-all.jar" />
	<property name="flashlight-asm-all.jar.manifest" value="${lib}/ASM-ALL-MANIFEST.MF" />

	<property name="flashlight-asm-runtime.jar" value="${basedir}/flashlight-asm-runtime.jar" />
	<property name="flashlight-asm-runtime.jar.manifest" value="${lib}/ASM-RUNTIME-MANIFEST.MF" />

	<property name="flashlight-asm-servlet.jar" value="${basedir}/flashlight-asm-servlet.jar" />
	<property name="flashlight-asm-servlet.jar.manifest" value="${lib}/ASM-SERVLET-MANIFEST.MF" />

	<property name="flashlight-asm-instrument.jar" value="${basedir}/flashlight-asm-instrument.jar" />
	<property name="flashlight-asm-instrument.jar.manifest" value="${lib}/ASM-INSTRUMENT-MANIFEST.MF" />

	<property name="flashlight-asm-rewriter.jar" value="${basedir}/flashlight-asm-rewriter.jar" />
	<property name="flashlight-asm-rewriter.jar.manifest" value="${lib}/ASM-REWRITER-MANIFEST.MF" />


	<target name="compile-asm">
		<delete dir="${classes}" />
		<mkdir dir="${classes}" />
		<javac destdir="${classes}" source="1.5" target="1.5">
			<src path="${src}" />
			<src path="${src-asm}" />
			<classpath>
				<pathelement location="${asm.jar}" />
				<pathelement location="${servlet.jar}" />
			</classpath>
		</javac>
	</target>

	<target name="build-asm-all-jar" depends="compile-asm">
		<unzip src="${asm.jar}" dest="${classes}" />
		<jar destfile="${flashlight-asm-all.jar}" basedir="${classes}">
			<manifest>
			  <attribute name="Manifest-Version" value="1.0"/>
			  <attribute name="Premain-Class" value="com.surelogic._flashlight.instrument.FlashlightAgent"/>
			  <attribute name="Can-Redefine-Classes" value="false"/>
  		  <attribute name="Main-Class" value="com.surelogic._flashlight.rewriter.FlashlightClassRewriter"/>
			</manifest>
	  </jar>
	</target>

	<target name="build-asm-runtime-jar" depends="compile-asm">
		<jar destfile="${flashlight-asm-runtime.jar}" basedir="${classes}">
			<include name="**/com/surelogic/_flashlight/*.class" />
			<include name="**/com/surelogic/_flashlight/emory/*.class" />
			<include name="**/com/surelogic/_flashlight/rewriter/runtime/*.class" />
			<include name="**/com/surelogic/_flashlight/rewriter/test/*.class" />
			<manifest>
			  <attribute name="Manifest-Version" value="1.0"/>
			</manifest>
	  </jar>
	</target>

	<target name="build-asm-servlet-jar" depends="compile-asm">
		<jar destfile="${flashlight-asm-servlet.jar}" basedir="${classes}">
			<include name="**/com/surelogic/_flashlight/servlet/*.class" />
			<manifest>
			  <attribute name="Manifest-Version" value="1.0"/>
			</manifest>
	  </jar>
	</target>

	<target name="build-asm-rewriter-jar" depends="compile-asm">
		<jar destfile="${flashlight-asm-rewriter.jar}" basedir="${classes}">
			<include name="**/com/surelogic/_flashlight/rewriter/*.class" />
			<manifest>
			  <attribute name="Manifest-Version" value="1.0"/>
  		  <attribute name="Main-Class" value="com.surelogic._flashlight.rewriter.FlashlightClassRewriter"/>
				<attribute name="Class-Path" value="asm-3.1.jar"/>
			</manifest>
	  </jar>
	</target>

	<target name="build-asm-instrument-jar" depends="compile-asm">
		<jar destfile="${flashlight-asm-instrument.jar}" basedir="${classes}">
			<include name="**/com/surelogic/_flashlight/instrument/*.class" />
			<manifest>
			  <attribute name="Manifest-Version" value="1.0"/>
			  <attribute name="Premain-Class" value="com.surelogic._flashlight.instrument.FlashlightAgent"/>
			  <attribute name="Can-Redefine-Classes" value="false"/>
				<attribute name="Class-Path" value="flashlight-asm-rewriter.jar flashlight-asm-runtime.jar"/>
			</manifest>
	  </jar>
	</target>

	<target name="build-asm-jars" depends="build-asm-all-jar, build-asm-runtime-jar, build-asm-servlet-jar, build-asm-instrument-jar, build-asm-rewriter-jar" />
	
	<target name="compile-test-code" depends="build-asm-all-jar">
		<delete dir="${classes}" />
		<mkdir dir="${classes}" />
		<javac srcdir="${test}" destdir="${classes}" source="1.5" target="1.5">
			<classpath>
				<pathelement path="${java.class.path}" />
				<pathelement location="${junit.jar}" />
				<pathelement location="${flashlight-asm-all.jar}" />
			</classpath>
		</javac>
	</target>


	<path id="test.classpath">
		<pathelement location="${classes}" />
		<pathelement path="${java.class.path}" />
		<pathelement location="${junit.jar}" />
		<pathelement location="${flashlight-asm-all.jar}" />
	</path>

	<target name="run-store-tests" depends="compile-test-code">
		<echo message="(These tests do not use the instrumentation)" />
		<echo message=" - The below test might fail if the GC gods do not smile upon it" />
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestBasicRefinery" />
		</junit>
		<echo message=" - The below test might fail if the GC gods do not smile upon it" />
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestBasicSharedState" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestEntities" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestKeyField" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestObservedField" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestOutput" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestPhantom" />
		</junit>
	</target>
</project>
