<project name="flashlight-instrumentation-5.0" default="build-jars">

	<property environment="env" />

	<property name="lib" value="${basedir}/lib" />
	<property name="classes" value="${basedir}/bin" />
	
	<property name="src" value="${basedir}/src" />
	<property name="src-asm" value="${basedir}/src-asm" />
	<property name="test" value="${basedir}/test" />

	<property name="asm.jar" value="${lib}/asm-3.1.jar" />
	<property name="asm-commons.jar" value="${lib}/asm-commons-3.1.jar" />
	<property name="servlet.jar" value="${lib}/servlet-2_5-api.jar" />

	<property name="junit.jar" value="${lib}/junit-4.3.1.jar" />

	<property name="flashlight-all.jar" value="${basedir}/flashlight-all.jar" />
	<property name="flashlight-all.jar.manifest" value="${lib}/ALL-MANIFEST.MF" />

	<property name="flashlight-runtime.jar" value="${basedir}/flashlight-runtime.jar" />
	<property name="flashlight-runtime.jar.manifest" value="${lib}/RUNTIME-MANIFEST.MF" />

	<property name="flashlight-servlet.jar" value="${basedir}/flashlight-servlet.jar" />
	<property name="flashlight-servlet.jar.manifest" value="${lib}/SERVLET-MANIFEST.MF" />

	<property name="flashlight-instrument.jar" value="${basedir}/flashlight-instrument.jar" />
	<property name="flashlight-instrument.jar.manifest" value="${lib}/INSTRUMENT-MANIFEST.MF" />

	<property name="flashlight-rewriter.jar" value="${basedir}/flashlight-rewriter.jar" />
	<property name="flashlight-rewriter.jar.manifest" value="${lib}/REWRITER-MANIFEST.MF" />

	
	
	<target name="clean">
		<delete file="${flashlight-all.jar}"/>
		<delete file="${flashlight-runtime.jar}"/>
		<delete file="${flashlight-servlet.jar}"/>
		<delete file="${flashlight-instrument.jar}"/>
		<delete file="${flashlight-rewriter.jar}"/>
	</target>
		
	

	<target name="compile">
		<delete dir="${classes}" />
		<mkdir dir="${classes}" />
		<javac destdir="${classes}" debug="true" source="1.5" target="1.5">
			<src path="${src}" />
			<src path="${src-asm}" />
			<classpath>
				<pathelement location="${asm.jar}" />
				<pathelement location="${asm-commons.jar}" />
				<pathelement location="${servlet.jar}" />
			</classpath>
		</javac>
	</target>

	<target name="build-all-jar">
		<unzip src="${asm.jar}" dest="${classes}" />
		<unzip src="${asm-commons.jar}" dest="${classes}" />
		<jar destfile="${flashlight-all.jar}" basedir="${classes}">
			<manifest>
			  <attribute name="Manifest-Version" value="1.0"/>
			  <attribute name="Premain-Class" value="com.surelogic._flashlight.instrument.FlashlightAgent"/>
			  <attribute name="Can-Redefine-Classes" value="false"/>
  		  <attribute name="Main-Class" value="com.surelogic._flashlight.rewriter.engine.RewriteEngine"/>
			</manifest>
	  </jar>
	</target>

	<target name="build-runtime-jar">
		<jar destfile="${flashlight-runtime.jar}" basedir="${classes}">
			<include name="**/com/surelogic/_flashlight/*" />
			<include name="**/com/surelogic/_flashlight/emory/*" />
			<include name="**/com/surelogic/_flashlight/rewriter/runtime/*" />
			<include name="**/com/surelogic/_flashlight/rewriter/test/*" />
			<manifest>
			  <attribute name="Manifest-Version" value="1.0"/>
			</manifest>
	  </jar>
	</target>

	<target name="build-servlet-jar">
		<jar destfile="${flashlight-servlet.jar}" basedir="${classes}">
			<include name="**/com/surelogic/_flashlight/servlet/*" />
			<manifest>
			  <attribute name="Manifest-Version" value="1.0"/>
				<attribute name="Class-Path" value="flashlight-runtime.jar"/>
			</manifest>
	  </jar>
	</target>

	<target name="build-rewriter-jar">
		<jar destfile="${flashlight-rewriter.jar}" basedir="${classes}">
			<include name="**/com/surelogic/_flashlight/rewriter/*" />
			<include name="**/com/surelogic/_flashlight/rewriter/engine/*" />
			<manifest>
			  <attribute name="Manifest-Version" value="1.0"/>
  		  <attribute name="Main-Class" value="com.surelogic._flashlight.rewriter.engine.RewriteEngine"/>
				<attribute name="Class-Path" value="asm-3.1.jar asm-commons-3.1.jar"/>
			</manifest>
	  </jar>
	</target>

	<target name="build-instrument-jar">
		<jar destfile="${flashlight-instrument.jar}" basedir="${classes}">
			<include name="**/com/surelogic/_flashlight/instrument/*" />
			<manifest>
			  <attribute name="Manifest-Version" value="1.0"/>
			  <attribute name="Premain-Class" value="com.surelogic._flashlight.instrument.FlashlightAgent"/>
			  <attribute name="Can-Redefine-Classes" value="false"/>
				<attribute name="Class-Path" value="flashlight-rewriter.jar flashlight-runtime.jar"/>
			</manifest>
	  </jar>
	</target>

	<target name="build-jars-eclipse" depends="build-all-jar, build-runtime-jar, build-servlet-jar, build-instrument-jar, build-rewriter-jar" />

	<target name="build-jars" depends="compile, build-all-jar, build-runtime-jar, build-servlet-jar, build-instrument-jar, build-rewriter-jar" />

	<target name="compile-test-code" depends="build-jars">
		<delete dir="${classes}" />
		<mkdir dir="${classes}" />
		<javac srcdir="${test}" destdir="${classes}" source="1.5" target="1.5">
			<classpath>
				<pathelement path="${java.class.path}" />
				<pathelement location="${junit.jar}" />
				<pathelement location="${flashlight-all.jar}" />
			</classpath>
		</javac>
	</target>


	<path id="test.classpath">
		<pathelement location="${classes}" />
		<pathelement path="${java.class.path}" />
		<pathelement location="${junit.jar}" />
		<pathelement location="${flashlight-all.jar}" />
	</path>

	<target name="run-store-tests" depends="compile-test-code">
		<echo message="(These tests do not use the instrumentation)" />
		<echo message=" - The below test might fail if the GC gods do not smile upon it" />
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestBasicRefinery" />
		</junit>
		<echo message=" - The below test might fail if the GC gods do not smile upon it" />
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestBasicSharedState" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestEntities" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestKeyField" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestObservedField" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestOutput" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestPhantom" />
		</junit>
	</target>
</project>
