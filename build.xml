<project name="flashlight-instrumentation-5.0" default="run-store-tests">

	<property environment="env" />

	<property name="lib" value="${basedir}/lib" />
	<property name="classes" value="${basedir}/bin-cl" />
	<property name="src" value="${basedir}/src" />
	<property name="test" value="${basedir}/test" />

	<property name="aspectjrt.jar" value="${lib}/aspectjrt.jar" />
	<property name="aspectjtools.jar" value="${lib}/aspectjtools.jar" />
	<property name="aspectjweaver.jar" value="${lib}/aspectjweaver.jar" />

	<property name="junit.jar" value="${lib}/junit-4.3.1.jar" />

	<property name="flashlight.jar" value="${basedir}/flashlight.jar" />
	<property name="flashlight.jar.manifest" value="${lib}/MANIFEST.MF" />

	<taskdef resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties">
		<classpath>
			<pathelement location="${aspectjtools.jar}" />
		</classpath>
	</taskdef>


	<target name="compile">
		<delete dir="${classes}" />
		<mkdir dir="${classes}" />
		<javac srcdir="${src}" destdir="${classes}" source="1.5" />
		<iajc source="1.5" Xlint="ignore" X="joinpoints:synchronization" destdir="${classes}">
			<sourceroots>
				<pathelement location="${basedir}/src" />
			</sourceroots>
			<classpath>
				<pathelement path="${java.class.path}" />
				<pathelement location="${aspectjrt.jar}" />
			</classpath>
		</iajc>
	</target>

	<target name="build-jar" depends="compile">
		<unzip src="${aspectjweaver.jar}" dest="${classes}" />
		<copy todir="${classes}/META-INF">
			<fileset dir="${src}/META-INF" />
		</copy>
		<jar manifest="${flashlight.jar.manifest}" destfile="${flashlight.jar}" basedir="${classes}" />
	</target>

	<target name="compile-test-code" depends="build-jar">
		<delete dir="${classes}" />
		<mkdir dir="${classes}" />
		<javac srcdir="${test}" destdir="${classes}" source="1.5">
			<classpath>
				<pathelement path="${java.class.path}" />
				<pathelement location="${junit.jar}" />
				<pathelement location="${flashlight.jar}" />
			</classpath>
		</javac>
	</target>


	<path id="test.classpath">
		<pathelement location="${classes}" />
		<pathelement path="${java.class.path}" />
		<pathelement location="${junit.jar}" />
		<pathelement location="${flashlight.jar}" />
	</path>

	<target name="run-store-tests" depends="compile-test-code">
		<echo message="(These tests do not use the instrumentation)" />
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestBasicRefinery" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestBasicSharedState" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestEntities" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestKeyField" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestObservedField" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestOutput" />
		</junit>
		<junit printsummary="on" fork="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<test name="com.surelogic._flashlight.TestPhantom" />
		</junit>
	</target>
</project>
